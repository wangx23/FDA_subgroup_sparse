{
indi = ind1 == i
Bmlist[[i]] = xm[indi,]
ylist[[i]] = y1[indi]
}
deltamold = t(Dmat %*% betam)
vm = matrix(0,p, npair)
flag = 0
niteration = 0
for(m in 1:maxiter)
{
## revised admm
resadmm = revisedadmm(Bmlist,ylist,n,p, npair,Dmat,deltamold, vm,
lam, nu, gam,
theta, lamj, sig2)
betam = resadmm$betam
deltam = resadmm$deltam
betadiff = resadmm$betadiff
vm = resadmm$vm
### remove mean part ###
# bsmean = rep(0, ntotal)
# for(i in 1:n)
# {
#   indi = ind == uind[i]
#   bsmean[indi] = Bmlist[[i]] %*% betam[i,]
# }
#
# #### newton
# datasub = data.frame(ind = ind, obs = y - bsmean, time = tm) ## substract mean
# datalist = fpca.format(datasub)
#
# ## auxillary of newton
# phiaux = apply(matrix(1:n),MARGIN=1,Phi.aux,Bmlist = Bmlist,datalist=datalist)
#
# newton.result = Newton.New(theta,phiaux,sqrt(sig2),lamj,datalist,n,sl.v,max.step,tolnt,condtol)
#
#
# step = newton.result[[7]]
# #like<-newton.result[[1]][1:step]
# theta = newton.result[[2]][,,step]
# lamj = newton.result[[3]][step,]
# sig.up = newton.result[[4]][step]
# # gradB<-newton.result[[5]][,,step]
# # gradL<-newton.result[[6]][step,]
# # cond<-newton.result[[8]]
# # error.c<-newton.result[[9]]
#
# sig2 = sig.up^2
norm1 = norm(betadiff,"F")
norm2 = norm(deltam,"F")
tolpri = tolabs*sqrt(npair*p) + tolrel*max(norm1,norm2)
toldual = tolabs*sqrt(n * p) + tolrel * norm(vm %*% Dmat, "F")
rm = norm(betadiff - deltam, "F")
sm = nu * norm((deltam - deltamold)%*%Dmat, "F")
deltamold = deltam
niteration = niteration + 1
if(rm <= tolpri & sm <= toldual)
{
break
}
}
if(niteration == maxiter)
{
flag = 1
}
m
betam
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
dat = simdat(sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
knots = seq(0,1,length.out = 6)[2:5]
boundary = c(0,1)
ind = dat$ind
tm = dat$time
y = dat$obs
group = unique(dat[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
knots = seq(0,1,length.out = 7)[2:6]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 0.5,maxiter = 100)
res1$betam
getgroup(res1$deltam)
getgroup(res1$deltam,140)
group
group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
alpm = res0$alpm
sig2 = res0$sig2
theta = res0$theta
lamj = res0$lamj
betam = res0$alpm[group0,]
sig2
theta
lamj
knots
betam0 = initialcoef(ind = ind,tm = tm,y = y,knots = knots,
boundary = boundary,lamv = lamv)
### initial value of theta, lamj and sig2
group0 = kmeans(betam0,K0)$cluster
group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
lamj = res0$lamj
lamj
sig2 = 0.1
lamj = c(0.1,0.2)
mvec = c(30,40)
ncl = 70
dat = simdat(sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
knots = seq(0,1,length.out = 6)[2:5]
boundary = c(0,1)
ind = dat$ind
tm = dat$time
y = dat$obs
group = unique(dat[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
group0 = kmeans(betam0,K0)$cluster
group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
alpm = res0$alpm
group
### initial value of beta ignoring covaraince structure
betam0 = initialcoef(ind = ind,tm = tm,y = y,knots = knots,
boundary = boundary,lamv = lamv)
dim(betam0)
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
alpm = res0$alpm
sig2 = res0$sig2
theta = res0$theta
lamj = res0$lamj
betam = res0$alpm[group0,]
lamj
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 0.5,maxiter = 100)
res1$betam
getgroup(res1$deltam,140)
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 0.6,maxiter = 100)
res1$niteration
res1$groupest
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
res0$alpm
res0$sig2
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 0.6,maxiter = 100)
res1$betaavg
knots
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1,maxiter = 100)
res1$niteration
res1$betaavg
res1$sig2
res1$theta
res1$lamj
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.2,maxiter = 100)
res1$betam
res1$groupest
plot(res1$betaavg)
res1$betaavg
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.3,maxiter = 100)
res1$betam
plot(res1$betaavg)
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.4,maxiter = 100)
res1$flag
plot(res1$betam)
plot(res1$groupest)
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.4,maxiter = 100)
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.4,maxiter = 10)
res1$betam
res1$sig2
res1$theta
res1$lamj
ntotal = length(y)
knotsall = c(rep(boundary[1],4),knots, rep(boundary[2],4))
obasisobj = OBasis(knotsall)
Bm = evaluate(obasisobj,tm)  ## orthogonal
p = ncol(Bm)
uind = unique(ind)
n = length(uind)
npair = n*(n-1)/2
Bmlist = list()
ylist = list()
for(i in 1:n)
{
indi = ind == uind[i]
Bmlist[[i]] = Bm[indi,]
ylist[[i]] = y[indi]
}
if(length(sl.v)<max.step){
sl.v<-c(sl.v,rep(1,max.step-length(sl.v)))
}else{
sl.v<-sl.v[1:max.step]
}
set.seed(seed)
### initial value of beta ignoring covaraince structure
betam0 = initialcoef(ind = ind,tm = tm,y = y,knots = knots,
boundary = boundary,lamv = lamv)
### initial value of theta, lamj and sig2
group0 = kmeans(betam0,K0)$cluster
group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
alpm = res0$alpm
sig2 = res0$sig2
theta = res0$theta
lamj = res0$lamj
betam = res0$alpm[group0,]
sig2
res1$sig2
bsmean = rep(0, ntotal)
for(i in 1:n)
{
indi = ind == uind[i]
bsmean[indi] = Bmlist[[i]] %*% betam[i,]
}
#### newton
datasub = data.frame(ind = ind, obs = y - bsmean, time = tm) ## substract mean
datalist = fpca.format(datasub)
## auxillary of newton
phiaux = apply(matrix(1:n),MARGIN=1,Phi.aux,Bmlist = Bmlist,datalist=datalist)
newton.result = Newton.New(theta,phiaux,sqrt(sig2),lamj,datalist,n,sl.v,max.step,tolnt,condtol)
step = newton.result[[7]]
#like<-newton.result[[1]][1:step]
theta = newton.result[[2]][,,step]
lamj = newton.result[[3]][step,]
sig.up = newton.result[[4]][step]
# gradB<-newton.result[[5]][,,step]
# gradL<-newton.result[[6]][step,]
# cond<-newton.result[[8]]
# error.c<-newton.result[[9]]
sig2 = sig.up^2
sig2
lamj
res0$lamj
step
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
source('~/Google Drive/Research/FDA_subgroup_sparse/code/FDAsubgroup.R')
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.4,maxiter = 1)
res1$sig2
res1$betam
getgroup(res1$deltam)
getgroup(res1$deltam,140)
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1.4,maxiter = 10)
getgroup(res1$deltam,140)
res1$lamj
res1$sig2
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1,maxiter = 10)
res1$betam
getgroup(res1$deltam,140)
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 1,maxiter = 10)
res1$betam
res1$groupest
res1$sig2
head(res1$betam)
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,lam = 0.8,maxiter = 10)
res1$niteration
res1$betam
head(res1$betaavg)
res1$groupest
res1$sig2
res1$lamj
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 0.6,maxiter = 10)
res1$betam
head(res1$betaavg)
res1$sig2
res1$lamj
plot(res1$betam)
res1$groupest
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 0.7,maxiter = 10)
res1$betam
head(res1$betam)
beta1 = c(-2,-2,-2,-2,-2)
beta2 = c(2,2,2,2,2)
betam12 = rbind(beta1,beta2)
knots
dim(res1$betam)
beta1 = c(-2,-2,-2,-2,-2,-2)
beta2 = c(2,2,2,2,2,2)
knots = seq(0,1,length.out = 4)[2:4]
knots
knots = seq(0,1,length.out = 4)[2:3]
knots
knotsall =  c(rep(0,4),knots, rep(1,4))
obasisobj = OBasis(knotsall)
Bm = evaluate(obasisobj,tm)  ## orthogonal
head(Bm)
knots
group
simdat1 = function(Bm, betag, sig2, lamj, mvec, ncl = 50, seed = 2228 )
{
set.seed(seed)
## number of observations for each subject
nsub = sample(mvec[1]:mvec[2], ncl*2, replace = TRUE)
ntotal = sum(nsub)
group = rep(1:2, each = ncl)
dat = data.frame(group = rep(group, nsub),
ind = rep(1:(2*ncl),nsub),
time = runif(ntotal),
obs = rep(0, ntotal))
rande = sqrt(sig2) * rnorm(ntotal)
meanvec = rep(0, ntotal)
meanvec[dat$group==1] = Bm[dat$group==1] %*%betag[1,]
meanvec[dat$group==2] = Bm[dat$group==2] %*%betag[2,]
vi = rep(0, ntotal)
for(i in 1:(ncl*2))
{
timei = dat$time[dat$ind==i]
vi[dat$ind ==i] = sqrt(lamj[1]) * rnorm(1) * psi1(timei) +
sqrt(lamj[2]) * rnorm(1) * psi2(timei)
}
dat$obs = meanvec + vi + rande
return(dat)
}
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
dat1 = simdat1(Bm, beta12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
dat1 = simdat1(Bm, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
betam12
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
dat1 = simdat1(Bm, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
betag = betam12
nsub = sample(mvec[1]:mvec[2], ncl*2, replace = TRUE)
ntotal = sum(nsub)
group = rep(1:2, each = ncl)
dat = data.frame(group = rep(group, nsub),
ind = rep(1:(2*ncl),nsub),
time = runif(ntotal),
obs = rep(0, ntotal))
rande = sqrt(sig2) * rnorm(ntotal)
meanvec = rep(0, ntotal)
meanvec[dat$group==1] = Bm[dat$group==1] %*% t(betag[1,])
meanvec[dat$group==2] = Bm[dat$group==2] %*% t(betag[2,])
Bm
dim(Bm)
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
knots = seq(0,1,length.out = 4)[2:3]
knotsall =  c(rep(0,4),knots, rep(1,4))
nsub = sample(mvec[1]:mvec[2], ncl*2, replace = TRUE)
ntotal = sum(nsub)
group = rep(1:2, each = ncl)
dat = data.frame(group = rep(group, nsub),
ind = rep(1:(2*ncl),nsub),
time = runif(ntotal),
obs = rep(0, ntotal))
obasisobj = OBasis(knotsall)
Bm = evaluate(obasisobj,dat$tm)  ## orthogonal
dat$time
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
Bm = evaluate(obasisobj,dat$time)  ## orthogonal
rande = sqrt(sig2) * rnorm(ntotal)
meanvec = rep(0, ntotal)
meanvec[dat$group==1] = Bm[dat$group==1] %*% t(betag[1,])
meanvec[dat$group==2] = Bm[dat$group==2] %*% t(betag[2,])
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
source('~/Research/FDA_subgroup_sparse/code/simdat.R')
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
Bm[dat$group==1,] %*% (betag[1,])
Bm[dat$group==1,] %*% t(betag[1,])
dim(Bm)
betam12
knots
beta1 = c(-2,-2,-2,-2,-2,-2)
beta2 = c(2,2,2,2,2,2)
betam12 = rbind(beta1,beta2)
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 0.7,maxiter = 10)
res1$betaavg
res1$flag
res1$betam
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 0.7,maxiter = 50)
res1$flag
res1$niteration
res1$groupest
res1$betaavg
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$groupest
group
group == group
sum(group == group)
res1$betaavg
res1$sig2
res1$lamj
betam0 = initialcoef(ind = ind,tm = tm,y = y,knots = knots,
boundary = boundary,lamv = lamv)
### initial value of theta, lamj and sig2
group0 = kmeans(betam0,K0)$cluster
#group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
res0$lamj
res1$theta
?fpca
?fpca.mle
library(fpca)
data(easy)
##sample trajectory
plot(easy$data[,3],easy$data[,2],xlab="grid",ylab="",type='p')
for(i in 1:500){
cur<-easy$data[easy$data[,1]==i,]
points(cur[,3],cur[,2],type="l")
}
## candidate models for fitting
M.set<-c(4,5,6)
r.set<-c(2,3,4)
##parameters for fpca.mle
ini.method="EM"
basis.method="bs"
sl.v=rep(0.5,10)
max.step=50
grid.l=seq(0,1,0.01)
grids=seq(0,1,0.002)
data.m = easy$data
##fit candidate models by fpca.mle
result<-fpca.mle(easy$data, M.set,r.set,ini.method, basis.method,sl.v,max.step,grid.l,grids)
summary(result)
result$error_var
result$eigenvalues
seed = 1
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$lamj
sig2 = 0.1
lamj = c(0.2,0.1)
mvec = c(30,40)
ncl = 70
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$flag
res1$lamj
res1$theta
sig2 = 0.1
lamj = c(0.1,0.2)
mvec = c(30,40)
ncl = 70
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$lamj
res1$theta
res1$betam
betam0 = initialcoef(ind = ind,tm = tm,y = y,knots = knots,
boundary = boundary,lamv = lamv)
### initial value of theta, lamj and sig2
group0 = kmeans(betam0,K0)$cluster
#group0 = group
res0 = EMgroup(ind = ind,tm = tm, y = y, knots= knots,
group0 = group0, P = P, betam0 = betam0, boundary = boundary,
maxiter = maxiterem, tol = tolem)
gropu0
group0
source('~/Research/FDA_subgroup_sparse/code/revisedadmm.R')
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$betam
res1$betaavg
beta1 = rep(-1,6)
beta2 = rep(1,6)
betam12 = rbind(beta1,beta2)
dat1 = simdat1(knots, betam12, sig2 = sig2,lamj = lamj,mvec = mvec,ncl = ncl)
ind = dat1$ind
tm = dat1$time
y = dat1$obs
group = unique(dat1[,1:2])[,1]
lamv = seq(0,20, by = 0.5)[-1]
res1 = FDAsubgroup(ind = ind,tm = tm,y = y,P = 2,knots = knots,
lam = 1,maxiter = 50)
res1$betaavg
res1$groupest
res1$sig2
res1$lamj
res1$theta
getwd()
